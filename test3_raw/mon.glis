68K GAS  mon.s 			page 1


   1               	*****************
   2               	** 各種レジスタ定義
   3               	*****************
   4               	
   5               	
   6               	** レジスタ群の先頭 ***************
   7               		.equ REGBASE, 0xFFF000	/* DMAP を使用． */
   8               		.equ IOBASE, 0x00d00000
   9               	
  10               	
  11               	** 割り込み関係のレジスタ***************
  12               		.equ IVR, REGBASE+0x300	/* 割り込みベクタレジスタ */
  13               		.equ IMR, REGBASE+0x304	/* 割り込みマスクレジスタ */
  14               		.equ ISR, REGBASE+0x30c	/* 割り込みステータスレジスタ */
  15               		.equ IPR, REGBASE+0x310	/* 割り込みペンディングレジスタ */
  16               	
  17               	** タイマ関係のレジスタ ***************
  18               		.equ TCTL1, REGBASE+0x600	/* タイマ１コントロールレジスタ */
  19               		.equ TPRER1, REGBASE+0x602	/* タイマ１プリスケーラレジスタ */
  20               		.equ TCMP1, REGBASE+0x604	/* タイマ１コンペアレジスタ */
  21               		.equ TCN1, REGBASE+0x608	/* タイマ１カウンタレジスタ */
  22               		.equ TSTAT1, REGBASE+0x60a	/* タイマ１ステータスレジスタ */
  23               	
  24               	
  25               	/* キューのオフセットと必要領域計算 */
  26               	.section .bss
  27               	
  28               		.equ	B_SIZE,	256	
  29               		.equ	TOP,	0
  30               		.equ	BOTTOM,	B_SIZE
  31               		.equ	IN,	BOTTOM + 4
  32               		.equ	OUT,	IN + 4
  33               		.equ	S,	OUT + 4
  34               		.equ	SIZE,	S + 2
  35               	
  36               	/* キュー用のメモリ領域確保 */
  37 0000 0000 0000 	QUEUES:		.ds.b	SIZE * 4
  37      0000 0000 
  37      0000 0000 
  37      0000 0000 
  37      0000 0000 
  38               	
  39               	
  40               	** UART1（送受信）関係のレジスタ 
  41               		.equ USTCNT1, REGBASE+0x900	/* UART1 ステータス/コントロールレジスタ*/
  42               		.equ UBAUD1, REGBASE+0x902	/* UART1 ボーコントロールレジスタ */
  43               		.equ URX1, REGBASE+0x904	/* UART1 受信レジスタ */
  44               		.equ UTX1, REGBASE+0x906	/* UART1 送信レジスタ */
  45               	
  46               	***************
  47               	** LED
  48               	**ボード搭載の LED 用レジスタ,使用法については付録 A.4.3.1
  49               	***************
  50               		.equ LED7, IOBASE+0x000002f
  51               		.equ LED6, IOBASE+0x000002d 
  52               		.equ LED5, IOBASE+0x000002b
  53               		.equ LED4, IOBASE+0x0000029
68K GAS  mon.s 			page 2


  54               		.equ LED3, IOBASE+0x000003f
  55               		.equ LED2, IOBASE+0x000003d
  56               		.equ LED1, IOBASE+0x000003b
  57               		.equ LED0, IOBASE+0x0000039
  58               	
  59               	********************
  60               	** スタック領域の確保 
  61               	********************
  62               		.section .bss
  63               		.even
  64               	SYS_STK:
  65 0438 0000 0000 		.ds.b 0x4000	/* システムスタック領域 */
  65      0000 0000 
  65      0000 0000 
  65      0000 0000 
  65      0000 0000 
  66               		.even 
  67               		SYS_STK_TOP: /*| システムスタック領域の最後尾 */
  68               	********************
  69               	** PUT/GETSTRING用変数の確保 
  70               	********************
  71               	
  72 4438 0000 0000 	sz:		.ds.l 1
  73 443c 0000 0000 	i:		.ds.l 1
  74               	
  75               	* SET_TIMER のコールバックルーチンポインタ
  76               	task_p:
  77 4440 0000 0000 	    .ds.l   1       /* 4バイトの領域を確保 */
  78               	
  79               	
  80               	
  81               	***************
  82               	** システムコール番号
  83               	***************
  84               	.equ SYSCALL_NUM_GETSTRING, 1
  85               	.equ SYSCALL_NUM_PUTSTRING, 2
  86               	.equ SYSCALL_NUM_RESET_TIMER, 3
  87               	.equ SYSCALL_NUM_SET_TIMER, 4
  88               	
  89               	
  90               	
  91               	
  92               		.section .text
  93               		.even
  94               		
  95               		.extern start
  96               		.global monitor_begin
  97               		.global BUF
  98               	
  99               	monitor_begin:
 100               	
 101               	***************************************************************
 102               	** 初期化 
 103               	** 内部デバイスレジスタには特定の値が設定されている． 
 104               	** その理由を知るには，付録 B にある各レジスタの仕様を参照すること．
 105               	***************************************************************
 106               	
68K GAS  mon.s 			page 3


 107               		.section .text
 108               		.even
 109               	
 110               	
 111               	boot: /* スーパーバイザ & 各種設定を行っている最中の割込禁止 */
 112 0000 46FC 2700 		move.w #0x2700,%SR
 113 0004 4FF9 0000 		lea.l SYS_STK_TOP, %SP /* | Set SSP */
 113      0000 
 114               		
 115               	****************
 116               	** 割り込みコントローラの初期化
 117               	****************
 118 000a 13FC 0040 		move.b #0x40, IVR	/* | ユーザ割り込みベクタ番号を| 0x40+level に設定． */
 118      00FF F300 
 119 0012 23FC 00FF 		move.l #0x00ffffff,IMR	/* | 全割り込みマスク */
 119      FFFF 00FF 
 119      F304 
 120               	
 121               	****************
 122               	** 送受信 (UART1) 関係の初期化 (割り込みレベルは 4 に固定されている) 
 123               	****************
 124 001c 33FC 0000 		move.w #0x0000, USTCNT1	/* | リセット */
 124      00FF F900 
 125 0024 33FC E100 		move.w #0xe100, USTCNT1	/* | 送受信可能, パリティなし, 1 stop, 8 bit, */
 125      00FF F900 
 126               					/* | 送受割り込み禁止 */
 127 002c 33FC 0038 		move.w #0x0038, UBAUD1	/* | baud rate = 230400 bps */
 127      00FF F902 
 128               	
 129               	
 130               	/* キューの初期化 */
 131               	QueueInitialize:
 132 0034 48E7 C0E0 		movem.l	%d0-%d1/%a0-%a2,-(%sp)
 133 0038 41F9 0000 		lea.l	QUEUES,%a0
 133      0000 
 134 003e 7004      		moveq	#4,%d0
 135               		
 136               	InitLoop:
 137 0040 2248      		movea.l	%a0,%a1
 138 0042 45D1      		lea.l	TOP(%a1),%a2
 139 0044 234A 0104 		move.l	%a2,IN(%a1)
 140 0048 234A 0108 		move.l	%a2,OUT(%a1)
 141 004c 337C 0000 		move.w	#0,S(%a1)
 141      010C 
 142 0052 D1FC 0000 		adda.l	#SIZE,%a0
 142      010E 
 143 0058 5380      		subq.l	#1,%d0
 144 005a 6600 FFE4 		bne	InitLoop
 145 005e 4CDF 0703 		movem.l	(%sp)+,%d0-%d1/%a0-%a2
 146               		
 147               	
 148               	
 149               	****************
 150               	** タイマ関係の初期化 (割り込みレベルは 6 に固定されている) 
 151               	*****************
 152 0062 33FC 0004 		move.w #0x0004, TCTL1	/* restart, 割り込み不可 */
 152      00FF F600 
68K GAS  mon.s 			page 4


 153               	                        **システムクロックの 1/16 を単位として計時，
 154               	                        **タイマ使用停止
 155               	
 156               							
 157               		* TRAP #0 ハンドラをベクタテーブルに登録
 158 006a 21FC 0000 		move.l	#TRAP0_HANDLER, 0x0080
 158      0000 0080 
 159               		* TRAP 0 (ベクタ番号 32) のアドレスにハンドラを設定 
 160               		/* ★ 修正点 1: UART1 割り込み(レベル4, ベクタ68) ハンドラを設定 */
 161               	    /* ( IVR 0x40 + Level 4 = 0x44 (68), Address 68 * 4 = 0x110 ) */
 162 0072 21FC 0000 	    move.l  #send_or_receive, 0x110
 162      0000 0110 
 163               	    
 164               	    /* ★ 修正点 1: タイマ1 割り込み(レベル6, ベクタ70) ハンドラを設定 */
 165               	    /* ( IVR 0x40 + Level 6 = 0x46 (70), Address 70 * 4 = 0x118 ) */
 166 007a 21FC 0000 	    move.l  #timer1_interrupt, 0x118
 166      0000 0118 
 167               	    
 168               	    /* ★ 修正点 2: UART(レベル4)の割り込みマスクをIMRで解除 */
 169               	    /* (IMRのビット4を0にする)<-ちがう！！！ */
 170 0082 02B9 FFFF 	    andi.l  #0xfffffff9, IMR
 170      FFF9 00FF 
 170      F304 
 171               		
 172 008c 6000 0002 		bra MAIN_INIT
 173               	
 174               	** メイン (PUTSTRING / INTERPUT 動作テスト)
 175               	***************************************************************
 176               	
 177               	
 178               	.section .bss
 179               	.even
 180 4444 0000 0000 	WORK: .ds.b 256        /* 受信データ格納用バッファ */
 180      0000 0000 
 180      0000 0000 
 180      0000 0000 
 180      0000 0000 
 181 4544 0000 0000 	BUF:  .ds.b 256 /* BUF[256] */
 181      0000 0000 
 181      0000 0000 
 181      0000 0000 
 181      0000 0000 
 182               	
 183               	.section .text
 184               	.even
 185               	MAIN_INIT:
 186               		* 走行レベル0で開始（スーパバイザモード）
 187 0090 46FC 2000 		move.w	#0x2000, %SR
 188               	
 189               	    * UART 割り込み許可（送受信割り込みON）
 190 0094 33FC E10C 		move.w  #0xE10C, USTCNT1
 190      00FF F900 
 191               	
 192 009c 4EF9 0000 		jmp start
 192      0000 
 193               	
 194               	
68K GAS  mon.s 			page 5


 195               	
 196               	****************************************************************
 197               	*** プログラム領域
 198               	****************************************************************
 199               	.section .text
 200               	.even
 201               	MAIN:
 202               	
 203               	
 204               	
 205               	
 206               	
 207               	
 208               	.section .text
 209               	send_or_receive:
 210 00a2 48E7 FFFF 	    movem.l	%d0-%d7/%a0-%a7,-(%sp) /* 安全のため全レジスタを退避 */
 211               	
 212               	* --- 1. 受信処理を優先的にチェック ---
 213               	check_receive:
 214 00a6 3639 00FF 	    move.w	URX1, %d3       /* URX1レジスタ(受信)を読み込み */
 214      F904 
 215 00ac 1403      	    move.b	%d3, %d2        /* %d2 にデータ部(bit 7-0)を先に保存 */
 216 00ae 0243 2000 	    andi.w	#0x2000, %d3    /* DATA READYフラグ(bit 13)をチェック */
 217 00b2 6700 0008 	    beq		check_send      /* フラグが0 (受信データなし) なら、送信チェックへ進
 218               	
 219               	* --- 受信データがあった場合の処理 ---
 220               	receive_init:
 221 00b6 7200      	    move.l	#0, %d1         /* ch=0 (UART1) */
 222 00b8 4EBA 021A 	    jsr		INTERGET        /* %d2のデータを使ってINTERGETを実行し、キューに入れる
 223               	                            /* INTERGETは %d2 のデータを使用します */
 224               	    
 225               	* --- 2. 送信処理をチェック ---
 226               	check_send:
 227 00bc 3639 00FF 	    move.w	UTX1, %d3       /* UTX1レジスタ(送信)を読み込み */
 227      F906 
 228 00c2 0243 8000 	    andi.w 	#0x8000, %d3    /* FIFO EMPTYフラグ(bit 15)をチェック */ 
 229 00c6 6700 0008 	    beq		SoR_end         /* フラグが0 (送信不可) なら、ハンドラを終了 */
 230               	
 231               	* --- 送信可能だった場合の処理 ---
 232               	send_init:
 233 00ca 7200      	    move.l	#0, %d1         /* ch=0 (UART1) */
 234 00cc 4EBA 011E 	    jsr		INTERPUT        /* INTERPUTを実行し、キューからデータを取り出し送信 */
 235               	
 236               	* --- 終了処理 ---
 237               	SoR_end:
 238 00d0 4CDF FFFF 	    movem.l	(%sp)+, %d0-%d7/%a0-%a7 /* 退避したレジスタを復帰 */
 239 00d4 4E73      	    rte
 240               	
 241               	
 242               	***************************************************************
 243               	** TRAP #0 システムコールハンドラ 
 244               	** (Step 8: OSサービスの呼び出しに対応)
 245               	***************************************************************
 246               	TRAP0_HANDLER:
 247               		
 248               		* サービス番号（%D0）に応じて分岐する
 249 00d6 0C80 0000 		cmpi.l	#1, %d0					/* %D0 が 1 (GETSTRING) かを比較する。*/
68K GAS  mon.s 			page 6


 249      0001 
 250 00dc 6700 0024 		beq		SYSCALL_GETSTRING
 251               		
 252 00e0 0C80 0000 		cmpi.l	#2, %d0					/* %D0 が 2 (PUTSTRING) かを比較する。*/
 252      0002 
 253 00e6 6700 0028 		beq		SYSCALL_PUTSTRING
 254               	
 255 00ea 0C80 0000 		cmpi.l	#3, %d0					/* %D0 が 3 (RESET_TIMER) かを比較する。*/
 255      0003 
 256 00f0 6700 002C 		beq		SYSCALL_RESET_TIMER
 257               		
 258 00f4 0C80 0000 		cmpi.l	#4, %d0					/* %D0 が 4 (SET_TIMER) かを比較する。*/
 258      0004 
 259 00fa 6700 0030 		beq		SYSCALL_SET_TIMER
 260               	
 261 00fe 6000 003A 		bra		TRAP0_EXIT				/* どのサービス番号にも一致しない場合、終了へ進む。*/
 262               	
 263               	SYSCALL_GETSTRING:
 264               		* GETSTRING(ch=0, p=%D2, size=%D3)
 265 0102 203C 0000 		move.l	#GETSTRING, %d0
 265      0000 
 266 0108 4EBA 0186 		jsr		GETSTRING				/* GETSTRING を呼び出す。*/
 267 010c 6000 002C 		bra		TRAP0_EXIT
 268               		
 269               	SYSCALL_PUTSTRING:
 270               		* PUTSTRING(ch=0, p=%D2, size=%D3)
 271 0110 203C 0000 		move.l	#PUTSTRING, %d0
 271      0000 
 272 0116 4EBA 011C 		jsr		PUTSTRING				/* PUTSTRING を呼び出す。*/
 273 011a 6000 001E 		bra		TRAP0_EXIT
 274               	
 275               	SYSCALL_RESET_TIMER:
 276               		* RESET_TIMER()
 277 011e 203C 0000 		move.l	#RESET_TIMER, %d0
 277      0000 
 278 0124 4EBA 01CA 		jsr		RESET_TIMER				/* RESET_TIMER を呼び出す。*/
 279 0128 6000 0010 		bra		TRAP0_EXIT
 280               		
 281               	SYSCALL_SET_TIMER:
 282               		* SET_TIMER(t=%D1, p=%D2)
 283 012c 203C 0000 		move.l	#SET_TIMER, %d0
 283      0000 
 284 0132 4EBA 01DC 		jsr		SET_TIMER				/* SET_TIMER を呼び出す。*/
 285 0136 6000 0002 		bra		TRAP0_EXIT
 286               	
 287               	TRAP0_EXIT:
 288 013a 4E73      		rte								/* 例外から復帰する。*/
 289               	
 290               	
 291               	**-----------------------------------------------------------------------
 292               	** INQ：番号noのキューにデータを入れる
 293               	** 入力：	キュー番号 no -> %d0.l
 294               	**			書き込む8bitデータ data -> %d1.b108
 295               	** 戻り値：	失敗0/成功1 -> %d0.l
 296               	**----------------------------------------------------------------------
 297               	INQ:
 298 013c 40E7      		move.w	%SR,-(%sp)					/* (1) 現走行レベルの退避 */
68K GAS  mon.s 			page 7


 299 013e 46FC 2700 		move.w	#0x2700,%SR					/* (2) 割り込み禁止(= 走行レベルを 7 に) */
 300 0142 48E7 3070 		movem.l	%d2-%d3/%a1-%a3,-(%sp)		/* レジスタの退避 */
 301 0146 43F9 0000 		lea.l	QUEUES,%a1					/* 指定された番号のキューのアドレスを計算 */
 301      0000 
 302 014c C0FC 010E 		mulu.w	#SIZE,%d0
 303 0150 D3C0      		adda.l	%d0,%a1
 304 0152 4EBA 000A 		jsr	PUT_BUF							/* (3) ～ (6) */
 305 0156 4CDF 0E0C 		movem.l	(%sp)+,%d2-%d3/%a1-%a3		/* レジスタの回復 */
 306 015a 46DF      		move.w	(%sp)+,%SR					/* (7) 旧走行レベルの回復 */
 307 015c 4E75      		rts
 308               	
 309               	PUT_BUF:
 310 015e 7400      		move.l	#0,%d2
 311 0160 3629 010C 		move.w	S(%a1),%d3
 312 0164 0C43 0100 		cmp.w	#B_SIZE,%d3					/* (3)  s == 256 ならば %d0 を 0(失敗)に設定し，(7) へ */
 313 0168 6700 0026 		beq	PUT_BUF_Finish
 314 016c 2469 0104 		movea.l	IN(%a1),%a2
 315 0170 1481      		move.b	%d1,(%a2)					/* (4) m[in] = data */
 316 0172 D5FC 0000 		adda.l	#1,%a2						/* in++ ( (5) の else ) */
 316      0001 
 317 0178 47E9 0100 		lea.l	BOTTOM(%a1),%a3
 318 017c B5CB      		cmpa.l	%a3,%a2						/* (5) if (in == bottom) in=top */
 319 017e 6500 0004 		bcs	PUT_BUF_STEP1
 320 0182 45D1      		lea.l	TOP(%a1),%a2
 321               	
 322               	PUT_BUF_STEP1:
 323 0184 234A 0104 		move.l	%a2,IN(%a1)
 324 0188 5243      		add.w	#1,%d3						/* (6) s++,                  */
 325 018a 3343 010C 		move.w	%d3,S(%a1)
 326 018e 7401      		move.l	#1,%d2						/*     %D0 を 1（成功）に設定 */
 327               	
 328               	PUT_BUF_Finish:
 329 0190 2002      		move.l	%d2,%d0
 330 0192 4E75      		rts
 331               	
 332               	**-----------------------------------------------------------------------
 333               	** OUTQ：番号noのキューからデータを一つ取り出す
 334               	** 入力：	キュー番号 no -> %d0.l
 335               	** 戻り値：	失敗0/成功1 -> %d0.l
 336               	** 			取り出した8bitデータ data -> %d1.b
 337               	**----------------------------------------------------------------------
 338               	OUTQ:
 339 0194 40E7      		move.w	%SR,-(%sp)					/* (1) 現走行レベルの退避 */
 340 0196 46FC 2700 		move.w	#0x2700,%SR					/* (2) 割り込み禁止(= 走行レベルを 7 に) */
 341 019a 48E7 3070 		movem.l	%d2-%d3/%a1-%a3,-(%sp)		/* レジスタの退避 */
 342 019e 43F9 0000 		lea.l	QUEUES,%a1					/* 指定された番号のキューのアドレスを計算 */
 342      0000 
 343 01a4 C0FC 010E 		mulu.w	#SIZE,%d0
 344 01a8 D3C0      		adda.l	%d0,%a1
 345 01aa 4EBA 000A 		jsr	GET_BUF							/* (3) ～ (6) */
 346 01ae 4CDF 0E0C 		movem.l	(%sp)+,%d2-%d3/%a1-%a3		/* レジスタの回復 */
 347 01b2 46DF      		move.w	(%sp)+,%SR					/* (7) 旧走行レベルの回復 */
 348 01b4 4E75      		rts
 349               	
 350               	GET_BUF:
 351 01b6 7400      		move.l	#0,%d2
 352 01b8 3629 010C 		move.w	S(%a1),%d3
68K GAS  mon.s 			page 8


 353 01bc 0C43 0000 		cmp.w	#0x00,%d3					/* (3)  s == 0 ならば %d0 を 0(失敗)に設定し，(7) へ */
 354 01c0 6700 0026 		beq	GET_BUF_Finish
 355 01c4 2469 0108 		movea.l	OUT(%a1),%a2
 356 01c8 1212      		move.b	(%a2),%d1					/* (4) data = m[out] */
 357 01ca D5FC 0000 		adda.l	#1,%a2						/* out++ ( (5) の else ) */
 357      0001 
 358 01d0 47E9 0100 		lea.l	BOTTOM(%a1),%a3
 359 01d4 B5CB      		cmpa.l	%a3,%a2						/* (5) if (out == bottom) iout=top */
 360 01d6 6500 0004 		bcs	GET_BUF_STEP1
 361 01da 45D1      		lea.l	TOP(%a1),%a2
 362               	
 363               	GET_BUF_STEP1:
 364 01dc 234A 0108 		move.l	%a2,OUT(%a1)
 365 01e0 5343      		sub.w	#1,%d3						/* (6) s--                   */
 366 01e2 3343 010C 		move.w	%d3,S(%a1)
 367 01e6 7401      		move.l	#1,%d2						/*     %d0 を 1（成功）に設定 */
 368               	
 369               	GET_BUF_Finish:	
 370 01e8 2002      		move.l	%d2,%d0
 371 01ea 4E75      		rts
 372               	
 373               	
 374               	*****************************************
 375               	**入力
 376               	  **チャネル ch→%d1
 377               	**戻り値
 378               	  **なし 
 379               	*****************************************
 380               	
 381               	
 382               	INTERPUT:
 383 01ec 48E7 80E0 		movem.l	 %a0-%a2/%d0,-(%sp)	/*レジスタ退避*/
 384               		
 385               		/*(1) 割り込み禁止（走行レベルを7に）*/
 386 01f0 007C 0700 		ori.w  #0x0700,%SR
 387               		
 388               		/*(2) chが0でないならば，何もせずに復帰*/
 389 01f4 0C81 0000 		cmp.l #0,%d1
 389      0000 
 390 01fa 6600 0032 		bne  END_of_INTERPUT
 391               		
 392               		/*(3) OUTQ(1,data) を実行する*/
 393 01fe 7001      		move.l  #1,%d0
 394 0200 4EBA FF92 		jsr  OUTQ
 395               		
 396               		/*(4) OUTQの戻り値が0(失敗)ならば，送信割り込みをマスク(USTCNT1 を操作)し
 397 0204 0C80 0000 		cmp.l #0,%d0			
 397      0000 
 398 020a 6700 001A 		beq MASK
 399               		
 400               		/*(5) dataを送信レジスタUTX1に代入して送信*/
 401 020e 2001      		move.l  %d1,%d0		
 402 0210 0280 0000 		andi.l  #0x000000ff, %d0	
 402      00FF 
 403 0216 0680 0000 		add.l   #0x0800,%d0		/*ヘッダの付与*/
 403      0800 
 404 021c 33C0 00FF 		move.w  %d0,UTX1	
68K GAS  mon.s 			page 9


 404      F906 
 405 0222 6000 000A 		bra    END_of_INTERPUT
 406               		
 407               	
 408               	MASK:
 409 0226 33FC E108 		move.w #0xe108,USTCNT1
 409      00FF F900 
 410               		/*move.l #0x00fffffb, IMR
 411               		move.w #0x2000, %SR*/
 412               		
 413               		
 414               	
 415               	END_of_INTERPUT:	
 416 022e 4CDF 0701 		movem.l	(%sp)+, %a0-%a2/%d0 /*レジスタ退復帰*/
 417 0232 4E75      		rts
 418               	
 419               	*****************************************
 420               	**入力
 421               	  **チャネル ch→%d1
 422               	  **データ読み込み先の先頭アドレス p→%d2
 423               	  **送信するデータ数 size→%d3
 424               	**戻り値
 425               	  **実際に送信したデータ数 sz→ %d0 
 426               	*****************************************
 427               		
 428               	
 429               	PUTSTRING:
 430 0234 48E7 00F0 		movem.l	 %a0-%a3,-(%sp)	/*レジスタ退避*/
 431               		
 432               		/*(1) chが0でないならば，何もせずに復帰*/
 433 0238 0C81 0000 		cmp.l    #0,%d1			
 433      0000 
 434 023e 6600 004A 		bne      END_of_PUTSTRING	/*chが0でないならば何もせずに復帰*/
 435               		
 436               		/*(2) sz ← 0 , i ← p*/
 437 0242 41F9 0000 		lea.l    sz,%a0
 437      0000 
 438 0248 43F9 0000 		lea.l    i,%a1
 438      0000 
 439 024e 20BC 0000 	    move.l   #0,(%a0) /*szを初期化*/
 439      0000 
 440 0254 2282      		move.l   %d2,(%a1)		/*iに文字列ポインタを保存*/
 441               		
 442               		/*(3) size = 0 ならば(10)へ*/
 443 0256 0C83 0000 		cmp.l    #0,%d3
 443      0000 
 444 025c 6700 002A 	 	beq      sz_SET			/*(10)へ*/
 445               		
 446               		/*(4) sz = size ならば (9) へ*/
 447               	loop_PUTSTRING:	
 448 0260 B690      		cmp.l    (%a0),%d3
 449 0262 6700 001C 		beq      UNMASK			/*sizeが0ならばアンマスクへ*/
 450               		
 451               		/*(5) INQ(1,i)を実行し，送信キューへi番地のデータを書き込む*/
 452 0266 7001      		move.l   #1,%d0		/*noにチャンネルをセット*/
 453 0268 2651      		movea.l  (%a1),%a3
 454 026a 1213      		move.b   (%a3),%d1		/*dataにp[i]をセット*/
68K GAS  mon.s 			page 10


 455 026c 4EBA FECE 		jsr 	 INQ
 456               	
 457               		/*(6) INQの復帰値が0(失敗/queue full)なら(9)へ*/
 458 0270 0C40 0000 		cmp      #0,%d0
 459 0274 6700 000A 		beq      UNMASK
 460               	
 461               		/*(7) sz++, i++*/
 462 0278 5290      		addq.l   #1,(%a0)			/*sz++*/
 463 027a 5291      		addq.l   #1,(%a1)			/*i++*/
 464               	
 465               		/*(8) (4) へ*/
 466 027c 6000 FFE2 		bra      loop_PUTSTRING
 467               	
 468               	/*(9) USTCNT1 を操作して送信割り込み許可 (アンマスク)*/
 469               	UNMASK:
 470 0280 33FC E10C 		move.w #0xe10c,USTCNT1
 470      00FF F900 
 471               	
 472               	/*(10) %D0 ←− sz*/
 473               	sz_SET:
 474 0288 2010      		move.l   (%a0),%d0		/*szをセット*/
 475               	
 476               	END_of_PUTSTRING:	
 477 028a 4CDF 0F00 		movem.l	(%sp)+, %a0-%a3
 478 028e 4E75      		rts
 479               		
 480               	*----------------------------------------------------------------------
 481               	* GETSTRING と INTERGET 
 482               	*----------------------------------------------------------------------
 483               	GETSTRING:
 484 0290 48E7 7880 		movem.l	%d1-%d4/%a0,-(%sp)		/* レジスタの退避 */
 485 0294 0C81 0000 		cmp.l	#0,%d1					/* (1) ch ≠ 0 なら何も実行せず復帰 */
 485      0000 
 486 029a 6600 0030 		bne	GETSTRING_END
 487               	
 488               	GETSTRING1:
 489 029e 7800      		move.l	#0,%d4					/* (2) sz <- 0 */
 490 02a0 2042      		move.l	%d2,%a0					/*     i <- p */
 491               	
 492               	GETSTRING2:
 493 02a2 B883      		cmp.l	%d3,%d4					/* (3) sz = size なら (9) へ */
 494 02a4 6700 0020 		beq	GETSTRING3
 495 02a8 7000      		move.l	#0,%d0					/* (4) OUTQ(0,data)により受信キューから8bitデータ読み込み */
 496 02aa 4EBA FEE8 		jsr	OUTQ
 497 02ae 0C80 0000 		cmp.l	#0,%d0					/* (5) OUTQの復帰値(%d0の値)が 0(失敗) なら (9) へ */
 497      0000 
 498 02b4 6700 0010 		beq	GETSTRING3
 499 02b8 1081      		move.b	%d1,(%a0)				/* (6) i番地にdataをコピー */
 500 02ba 5284      		addq.l	#1,%d4					/* (7) sz++ */
 501 02bc D1FC 0000 		adda.l	#1,%a0					/*     i++ */
 501      0001 
 502 02c2 6000 FFDE 		bra	GETSTRING2					/* (8) (3) へ */
 503               	
 504               	GETSTRING3:
 505 02c6 2004      		move.l	%d4,%d0					/* (9) %d0 <- sz */
 506 02c8 6000 0004 		bra	GETSTRING_Finish
 507               		
68K GAS  mon.s 			page 11


 508               	GETSTRING_END:
 509 02cc 7000      		move.l	#0,%d0
 510               	
 511               	GETSTRING_Finish:
 512 02ce 4CDF 011E 		movem.l	(%sp)+,%d1-%d4/%a0		/* レジスタの回復 */
 513 02d2 4E75      		rts
 514               	
 515               	INTERGET:
 516 02d4 48E7 C000 		movem.l	%d0-%d1,-(%sp)			/* レジスタの退避 */
 517 02d8 0C81 0000 		cmp.l	#0,%d1					/* (1) ch ≠ 0 ならば何も実行せず復帰 */
 517      0000 
 518 02de 6600 000A 		bne	INTERGET_Finish
 519 02e2 7000      		move.l	#0,%d0					/* (2) INQ(0,data) */
 520 02e4 2202      		move.l	%d2,%d1
 521 02e6 4EBA FE54 		jsr	INQ
 522               	
 523               	INTERGET_Finish:
 524 02ea 4CDF 0003 		movem.l	(%sp)+,%d0-%d1			/* レジスタの回復 */
 525 02ee 4E75      		rts
 526               	
 527               	
 528               	*----------------------------------------------------------------------
 529               	* RESET_TIMER ルーチン (タイマ停止 & 割り込み禁止)
 530               	*
 531               	* 役割: タイマーを安全に停止し、割り込みを禁止する。
 532               	*----------------------------------------------------------------------
 533               	RESET_TIMER:
 534 02f0 207C 00FF 	    move.l  #TCTL1, %A0        /* A0 に TCTL1 のアドレスをロード */
 534      F600 
 535 02f6 0250 FFFE 	    andi.w  #0xFFFE, (%A0)     /* タイマー停止 (TCTL1 Bit 0 'TEN' = 0) */
 536               	    
 537 02fa 207C 00FF 	    move.l  #IMR, %A0          /* A0 に IMR のアドレスをロード */
 537      F304 
 538               	    * IMR Bit 1 (Timer1) を 1 (マスク/禁止) に設定する
 539 0300 0090 0000 	    ori.l   #0x00000002, (%A0)
 539      0002 
 540               	    
 541 0306 33FC 0000 	    move.w  #0x0000, TSTAT1   /* 保留中の割り込みフラグをクリア */
 541      00FF F60A 
 542 030e 4E75      	    rts
 543               	
 544               	*----------------------------------------------------------------------
 545               	* SET_TIMER ルーチン (タイマ設定 & 割り込み許可)
 546               	*
 547               	* 役割: 指定時間後に指定ルーチンを呼び出すよう設定する。
 548               	* 引数:
 549               	* %D1.W : タイムアウト時間 t (0.1msec単位)
 550               	* %D2.L : コールバックルーチン p のアドレス
 551               	*----------------------------------------------------------------------
 552               	SET_TIMER:
 553 0310 207C 00FF 	    move.l  #TCTL1, %A0        /* A0 に TCTL1 のアドレスをロード */
 553      F600 
 554 0316 0250 FFFE 	    andi.w  #0xFFFE, (%A0)     /* タイマーを一旦停止 (安全のため) */
 555               	    
 556 031a 41F9 0000 	    lea.l   task_p, %A0        /* A0 に task_p 変数のアドレスをロード */
 556      0000 
 557 0320 2082      	    move.l  %D2, (%A0)        /* task_p にコールバックのアドレス (%D2) を保存 */
68K GAS  mon.s 			page 12


 558               	    
 559 0322 33FC 00CE 	    move.w  #206, TPRER1      /* プリスケーラを 0.1ms 周期に設定 */
 559      00FF F602 
 560 032a 33C1 00FF 	    move.w  %D1, TCMP1        /* 割り込み発生時間を設定 */
 560      F604 
 561 0330 33FC 0000 	    move.w  #0x0000, TSTAT1   /* 古いフラグをクリア */
 561      00FF F60A 
 562               	    
 563 0338 207C 00FF 	    move.l  #IMR, %A0          /* A0 に IMR のアドレスをロード */
 563      F304 
 564               	    * IMR Bit 1 (Timer1) を 0 (許可/アンマスク) に設定する
 565 033e 0290 FFFF 	    andi.l  #0xFFFFFFFD, (%A0)
 565      FFFD 
 566               	    
 567               	    * タイマー起動
 568               	    * (TCTL1 = 0x0015 -> IRQEN=1, FRR=1, TEN=1)
 569 0344 33FC 0015 	    move.w  #0x0015, TCTL1
 569      00FF F600 
 570 034c 4E75      	    rts
 571               	
 572               	*----------------------------------------------------------------------
 573               	* CALL_RP ルーチン (コールバック呼び出し)
 574               	*
 575               	* 役割: 割り込みハンドラから呼び出され、task_p のルーチンを実行する。
 576               	*----------------------------------------------------------------------
 577               	CALL_RP:
 578 034e 41F9 0000 	    lea.l   task_p, %A0        /* A0 に task_p 変数のアドレスをロード */
 578      0000 
 579 0354 2050      	    move.l  (%A0), %A0     /* A0 に task_p の中身 (コールバックアドレス) をロード
 580 0356 4E90      	    jsr     (%A0)          /* コールバックルーチンを実行 */
 581 0358 4E75      	    rts
 582               	
 583               	*----------------------------------------------------------------------
 584               	* タイマ1 割り込みハンドラ (ベクタ番号 70)
 585               	*
 586               	* 役割: タイマー割り込み発生時にCPUから直接呼び出される。
 587               	* (bootルーチンで 0x118 番地にこのアドレスを登録する必要あり)
 588               	*----------------------------------------------------------------------
 589               	timer1_interrupt:
 590               	    * 全てのレジスタをスタックに退避
 591 035a 48E7 FFFE 	    movem.l %D0-%D7/%A0-%A6, -(%SP)
 592               	
 593               	    * 割り込み要因を確認 (mon.s 方式)
 594 035e 3039 00FF 	    move.w  TSTAT1, %D0       /* TSTAT1 (16bit) を %D0 に読み込む */
 594      F60A 
 595 0364 0240 0001 	    andi.w  #0x0001, %D0      /* Bit 0 (COMPフラグ) だけを取り出す */
 596 0368 6700 000E 	    beq     .L_TIMER_EXIT   /* Bit 0 が 0 なら（タイマー要因でないなら）終了 */
 597               	
 598               	    * タイマー割り込みの処理
 599 036c 33FC 0000 	    move.w  #0x0000, TSTAT1   /* フラグをクリア */
 599      00FF F60A 
 600 0374 4EBA FFD8 	    jsr     CALL_RP           /* コールバック呼び出し */
 601               	
 602               	.L_TIMER_EXIT:
 603               	    * 全てのレジスタをスタックから復帰
 604 0378 4CDF 7FFF 	    movem.l (%SP)+, %D0-%D7/%A0-%A6
 605 037c 4E73      	    rte                     /* 割り込みから復帰 */
68K GAS  mon.s 			page 13


 606               	
 607               	
 608               	
 609               	
 610               	
 611               	*----------------------------------------------------------------------
 612               	* キュー定義 
 613               	*----------------------------------------------------------------------
 614               	.section .data
 615               	
 616 0000 3031 3233 	TDATA1: .ascii "0123456789ABCDEF"
 616      3435 3637 
 616      3839 4142 
 616      4344 4546 
 617 0010 6B6C 6D6E 	TDATA2: .ascii "klmnopqrstuvwxyz"
 617      6F70 7172 
 617      7374 7576 
 617      7778 797A 
 618               	.end
68K GAS  mon.s 			page 14


DEFINED SYMBOLS
               mon.s:7      *ABS*:0000000000fff000 REGBASE
               mon.s:8      *ABS*:0000000000d00000 IOBASE
               mon.s:12     *ABS*:0000000000fff300 IVR
               mon.s:13     *ABS*:0000000000fff304 IMR
               mon.s:14     *ABS*:0000000000fff30c ISR
               mon.s:15     *ABS*:0000000000fff310 IPR
               mon.s:18     *ABS*:0000000000fff600 TCTL1
               mon.s:19     *ABS*:0000000000fff602 TPRER1
               mon.s:20     *ABS*:0000000000fff604 TCMP1
               mon.s:21     *ABS*:0000000000fff608 TCN1
               mon.s:22     *ABS*:0000000000fff60a TSTAT1
               mon.s:28     *ABS*:0000000000000100 B_SIZE
               mon.s:29     *ABS*:0000000000000000 TOP
               mon.s:30     *ABS*:0000000000000100 BOTTOM
               mon.s:31     *ABS*:0000000000000104 IN
               mon.s:32     *ABS*:0000000000000108 OUT
               mon.s:33     *ABS*:000000000000010c S
               mon.s:34     *ABS*:000000000000010e SIZE
               mon.s:37     .bss:0000000000000000 QUEUES
               mon.s:41     *ABS*:0000000000fff900 USTCNT1
               mon.s:42     *ABS*:0000000000fff902 UBAUD1
               mon.s:43     *ABS*:0000000000fff904 URX1
               mon.s:44     *ABS*:0000000000fff906 UTX1
               mon.s:50     *ABS*:0000000000d0002f LED7
               mon.s:51     *ABS*:0000000000d0002d LED6
               mon.s:52     *ABS*:0000000000d0002b LED5
               mon.s:53     *ABS*:0000000000d00029 LED4
               mon.s:54     *ABS*:0000000000d0003f LED3
               mon.s:55     *ABS*:0000000000d0003d LED2
               mon.s:56     *ABS*:0000000000d0003b LED1
               mon.s:57     *ABS*:0000000000d00039 LED0
               mon.s:64     .bss:0000000000000438 SYS_STK
               mon.s:67     .bss:0000000000004438 SYS_STK_TOP
               mon.s:72     .bss:0000000000004438 sz
               mon.s:73     .bss:000000000000443c i
               mon.s:76     .bss:0000000000004440 task_p
               mon.s:84     *ABS*:0000000000000001 SYSCALL_NUM_GETSTRING
               mon.s:85     *ABS*:0000000000000002 SYSCALL_NUM_PUTSTRING
               mon.s:86     *ABS*:0000000000000003 SYSCALL_NUM_RESET_TIMER
               mon.s:87     *ABS*:0000000000000004 SYSCALL_NUM_SET_TIMER
               mon.s:99     .text:0000000000000000 monitor_begin
               mon.s:181    .bss:0000000000004544 BUF
               mon.s:111    .text:0000000000000000 boot
               mon.s:131    .text:0000000000000034 QueueInitialize
               mon.s:136    .text:0000000000000040 InitLoop
               mon.s:246    .text:00000000000000d6 TRAP0_HANDLER
               mon.s:209    .text:00000000000000a2 send_or_receive
               mon.s:589    .text:000000000000035a timer1_interrupt
               mon.s:185    .text:0000000000000090 MAIN_INIT
               mon.s:180    .bss:0000000000004444 WORK
               mon.s:201    .text:00000000000000a2 MAIN
               mon.s:213    .text:00000000000000a6 check_receive
               mon.s:226    .text:00000000000000bc check_send
               mon.s:220    .text:00000000000000b6 receive_init
               mon.s:515    .text:00000000000002d4 INTERGET
               mon.s:237    .text:00000000000000d0 SoR_end
68K GAS  mon.s 			page 15


               mon.s:232    .text:00000000000000ca send_init
               mon.s:382    .text:00000000000001ec INTERPUT
               mon.s:263    .text:0000000000000102 SYSCALL_GETSTRING
               mon.s:269    .text:0000000000000110 SYSCALL_PUTSTRING
               mon.s:275    .text:000000000000011e SYSCALL_RESET_TIMER
               mon.s:281    .text:000000000000012c SYSCALL_SET_TIMER
               mon.s:287    .text:000000000000013a TRAP0_EXIT
               mon.s:483    .text:0000000000000290 GETSTRING
               mon.s:429    .text:0000000000000234 PUTSTRING
               mon.s:533    .text:00000000000002f0 RESET_TIMER
               mon.s:552    .text:0000000000000310 SET_TIMER
               mon.s:297    .text:000000000000013c INQ
               mon.s:309    .text:000000000000015e PUT_BUF
               mon.s:328    .text:0000000000000190 PUT_BUF_Finish
               mon.s:322    .text:0000000000000184 PUT_BUF_STEP1
               mon.s:338    .text:0000000000000194 OUTQ
               mon.s:350    .text:00000000000001b6 GET_BUF
               mon.s:369    .text:00000000000001e8 GET_BUF_Finish
               mon.s:363    .text:00000000000001dc GET_BUF_STEP1
               mon.s:415    .text:000000000000022e END_of_INTERPUT
               mon.s:408    .text:0000000000000226 MASK
               mon.s:476    .text:000000000000028a END_of_PUTSTRING
               mon.s:473    .text:0000000000000288 sz_SET
               mon.s:447    .text:0000000000000260 loop_PUTSTRING
               mon.s:469    .text:0000000000000280 UNMASK
               mon.s:508    .text:00000000000002cc GETSTRING_END
               mon.s:488    .text:000000000000029e GETSTRING1
               mon.s:492    .text:00000000000002a2 GETSTRING2
               mon.s:504    .text:00000000000002c6 GETSTRING3
               mon.s:511    .text:00000000000002ce GETSTRING_Finish
               mon.s:523    .text:00000000000002ea INTERGET_Finish
               mon.s:577    .text:000000000000034e CALL_RP
               mon.s:616    .data:0000000000000000 TDATA1
               mon.s:617    .data:0000000000000010 TDATA2

UNDEFINED SYMBOLS
start
